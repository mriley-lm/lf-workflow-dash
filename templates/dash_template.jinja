{% macro render_status(label, wf) %}
<div class="p-3 rounded-lg border {% if wf and wf.status == 'success' %}bg-green-50 border-green-100{% elif wf and wf.status == 'failure' %}bg-red-50 border-red-100{% else %}bg-slate-50 border-slate-100{% endif %}">
    <div class="flex justify-between items-start mb-1">
        <p class="text-xs font-semibold uppercase tracking-wider text-slate-500">{{ label }}</p>
        {% if wf and wf.last_updated %}
            <span class="text-[10px] text-slate-400 font-mono">{{ wf.last_updated }}</span>
        {% endif %}
    </div>
    <div class="flex items-center space-x-2">
        {% if wf %}
            <span class="w-2.5 h-2.5 rounded-full {% if wf.status == 'success' %}bg-green-500{% elif wf.status == 'failure' %}bg-red-500{% else %}bg-slate-300{% endif %}"></span>
            <span class="text-sm font-medium">{{ wf.status | capitalize }}</span>
        {% else %}
            <span class="text-sm text-slate-400 italic">No Data</span>
        {% endif %}
    </div>
    {% if wf and wf.status == 'failure' and (wf.last_commit_sha or wf.last_commit_message) %}
    <div class="mt-2 pt-2 border-t border-slate-200">
        <p class="text-[10px] uppercase tracking-wider text-slate-500 mb-0.5">Last commit</p>
        {% if wf.last_commit_message %}
        <p class="text-xs text-slate-700 truncate" title="{{ wf.last_commit_message }}">{{ wf.last_commit_message }}</p>
        {% endif %}
        {% if wf.last_commit_sha %}
        <a href="https://github.com/{{ wf.owner }}/{{ wf.repo }}/commit/{{ wf.last_commit_sha }}" target="_blank" rel="noopener" class="text-[10px] font-mono text-indigo-600 hover:underline">{{ wf.last_commit_sha[:7] }}</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-success { @apply bg-green-100 text-green-800 border-green-200; }
        .status-failure { @apply bg-red-100 text-red-800 border-red-200; }
        .status-pending { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div class="max-w-7xl mx-auto py-10 px-4">
        <header class="mb-10 flex justify-between items-end">
            <div>
                <h1 class="text-4xl font-bold tracking-tight text-slate-900">{{ page_title }}</h1>
                <p class="mt-2 text-lg text-slate-600">Engineering Reliability & Deployment Status</p>
            </div>
            <div class="text-right text-sm text-slate-500">
                <div>Last updated: <span class="font-mono">{{ last_updated }}</span></div>
                <div class="mt-1 text-xs">Template: <span class="font-mono">{{ copier_semver }}</span></div>
            </div>
        </header>

       {% for project in all_projects %}
    {# Pre-calculate health stats for the badge #}
    {% set active_wfs = [project.smoke_test, project.live_build, project.build_docs, project.benchmarks] | reject('none') | list %}
    {% for other in project.other_workflows %}{% do active_wfs.append(other) %}{% endfor %}
    
    {% set total_count = active_wfs | length %}
    {% set success_count = active_wfs | selectattr('status', 'equalto', 'success') | list | length %}

    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <h2 class="text-xl font-bold text-slate-900">{{ project.repo }}</h2>
                    <span class="px-2.5 py-0.5 rounded-full text-xs font-bold 
                        {% if success_count == total_count and total_count > 0 %} bg-green-100 text-green-700
                        {% elif success_count > 0 %} bg-amber-100 text-amber-700
                        {% else %} bg-red-100 text-red-700 {% endif %}">
                        {{ success_count }}/{{ total_count }} Passing
                    </span>
                </div>
                <a href="https://github.com/{{ project.owner }}/{{ project.repo }}" class="text-sm text-indigo-600 hover:underline">View Repo â†’</a>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                {% if project.smoke_test %}{{ render_status("Smoke Test", project.smoke_test) }}{% endif %}
                {% if project.live_build %}{{ render_status("Live Build", project.live_build) }}{% endif %}
                {% if project.build_docs %}{{ render_status("Docs", project.build_docs) }}{% endif %}
                {% if project.benchmarks %}{{ render_status("Benchmarks", project.benchmarks) }}{% endif %}
                {% for other in project.other_workflows %}
                    {{ render_status(other.friendly_name or "Custom", other) }}
                {% endfor %}
            </div>
        </div>
    </div>
{% endfor %}
    </div>
</body>
</html>

