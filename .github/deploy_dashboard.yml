name: Deploy Executive Dashboard
on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch:   # Allows manual refresh

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Project
        run: pip install -e . # Uses the editable install fix we discussed

      - name: Generate Dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          python3 src/lf_workflow_dash/update_dashboard.py $GITHUB_TOKEN ./config/tracked_workflows.yaml index.html

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # Uploads the generated index.html and assets

  deploy:
    needs: update-and-deploy
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4